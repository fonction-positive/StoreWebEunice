# 邮箱验证重置密码功能

## 功能概述
在个人中心的安全设置中添加了通过邮箱验证码重置密码的功能，为已登录用户提供了一个安全便捷的密码重置方式。

## 使用场景
- 用户忘记当前密码，但已登录系统
- 用户想要重置密码但不记得旧密码
- 安全地通过邮箱验证身份后修改密码

## 功能特点
1. **邮箱验证**：通过发送验证码到用户注册邮箱
2. **倒计时限制**：60秒内不能重复发送验证码
3. **验证码过期**：验证码5分钟后自动失效
4. **密码强度**：新密码至少6位字符
5. **二次确认**：需要二次输入确认新密码

## 后端实现

### API 端点

#### 1. 发送重置密码验证码
- **路径**：`POST /api/v1/auth/send_reset_code/`
- **权限**：需要登录 (IsAuthenticated)
- **请求体**：无需参数（自动使用当前登录用户的邮箱）
- **成功响应**：
```json
{
  "detail": "验证码已发送到您的邮箱"
}
```
- **错误响应**：
```json
{
  "detail": "请等待XX秒后再试"
}
```

#### 2. 重置密码
- **路径**：`POST /api/v1/auth/reset_password/`
- **权限**：需要登录 (IsAuthenticated)
- **请求体**：
```json
{
  "code": "123456",
  "new_password": "new_secure_password"
}
```
- **成功响应**：
```json
{
  "detail": "密码重置成功"
}
```
- **错误响应**：
```json
{
  "detail": "验证码错误"
}
// 或
{
  "detail": "验证码已过期或不存在"
}
// 或
{
  "detail": "密码长度不能少于6位"
}
```

### 后端逻辑

#### SendResetPasswordCodeView
```python
class SendResetPasswordCodeView(APIView):
    """发送重置密码验证码"""
    permission_classes = (permissions.IsAuthenticated,)
    
    # 1. 获取当前登录用户的邮箱
    # 2. 检查发送频率（60秒限制）
    # 3. 生成6位随机验证码
    # 4. 存储到Redis（5分钟过期）
    # 5. 发送邮件
```

#### ResetPasswordView
```python
class ResetPasswordView(APIView):
    """通过邮箱验证码重置密码"""
    permission_classes = (permissions.IsAuthenticated,)
    
    # 1. 验证验证码和新密码是否为空
    # 2. 验证密码长度（至少6位）
    # 3. 从Redis获取验证码并验证
    # 4. 验证通过后重置密码
    # 5. 删除已使用的验证码
```

### Redis 缓存键
- 验证码存储：`reset_password_code:{email}`
- 发送频率限制：`reset_password_sent:{email}`

### 邮件模板
```
主题：StoreWeb 重置密码验证码

您好 {username}，

您正在进行重置密码操作，验证码是：{code}

验证码有效期为5分钟，请尽快使用。

如果这不是您本人的操作，请立即修改密码并联系客服。

---
StoreWeb 团队
```

## 前端实现

### 用户界面
位于 `个人中心 > 安全设置` 页面：

1. **修改密码**（原有功能）
   - 需要输入当前密码
   - 适用于记得旧密码的情况

2. **忘记密码**（新增功能）
   - 无需输入当前密码
   - 通过邮箱验证码重置
   - 包含以下字段：
     - 邮箱验证码输入框
     - 发送验证码按钮（带60秒倒计时）
     - 新密码输入框
     - 确认新密码输入框
     - 重置密码按钮

### 前端验证规则
```javascript
const resetPasswordRules = {
  code: [
    { required: true, message: '请输入验证码', trigger: 'blur' },
    { len: 6, message: '验证码为6位数字', trigger: 'blur' }
  ],
  new_password: [
    { required: true, message: '请输入新密码', trigger: 'blur' },
    { min: 6, message: '密码长度不能少于6位', trigger: 'blur' }
  ],
  confirm_new_password: [
    { required: true, message: '请确认新密码', trigger: 'blur' },
    { validator: validateConfirmResetPassword, trigger: 'blur' }
  ]
};
```

### 用户流程

```
用户进入个人中心 → 切换到安全设置
    ↓
点击"发送验证码"按钮
    ↓
系统发送验证码到邮箱（显示倒计时60秒）
    ↓
用户输入验证码
    ↓
用户输入新密码（两次）
    ↓
点击"重置密码"按钮
    ↓
系统验证并重置密码
    ↓
显示成功提示，表单自动清空
```

## 安全考虑

1. **身份验证**
   - 必须已登录才能使用此功能
   - 验证码只发送到用户注册邮箱

2. **防止滥用**
   - 60秒发送频率限制
   - 验证码5分钟过期
   - 验证码使用后立即删除

3. **密码要求**
   - 最少6位字符
   - 需要二次确认

4. **错误信息**
   - 提供清晰的错误提示
   - 避免泄露敏感信息

## 与现有功能的区别

| 功能 | 修改密码 | 重置密码 |
|------|---------|---------|
| 需要当前密码 | ✅ 是 | ❌ 否 |
| 需要邮箱验证 | ❌ 否 | ✅ 是 |
| 使用场景 | 记得旧密码 | 忘记旧密码 |
| 位置 | 安全设置 | 安全设置 |
| 权限要求 | 已登录 | 已登录 |

## 测试步骤

### 功能测试
1. ✅ 登录系统
2. ✅ 进入个人中心 > 安全设置
3. ✅ 在"忘记密码"区域点击"发送验证码"
4. ✅ 检查邮箱是否收到验证码
5. ✅ 输入验证码和新密码
6. ✅ 点击"重置密码"
7. ✅ 验证密码是否重置成功

### 边界测试
1. ✅ 60秒内重复点击发送验证码（应显示倒计时）
2. ✅ 输入错误的验证码（应显示错误提示）
3. ✅ 输入过期的验证码（应显示过期提示）
4. ✅ 新密码少于6位（应显示长度限制提示）
5. ✅ 两次密码输入不一致（应显示不一致提示）
6. ✅ 5分钟后使用验证码（应显示过期提示）

### 安全测试
1. ✅ 未登录状态访问API（应返回401）
2. ✅ 验证码是否在使用后删除
3. ✅ 邮件是否发送到正确的用户邮箱

## 可能的改进

1. **验证码输入优化**
   - 可以改为6个独立输入框（类似注册验证）
   - 自动聚焦和跳转

2. **安全增强**
   - 增加验证码错误次数限制
   - 错误3次后锁定一段时间

3. **用户体验**
   - 添加密码强度指示器
   - 显示密码要求提示

4. **通知功能**
   - 密码重置成功后发送通知邮件
   - 记录密码修改历史

## 文件清单

### 后端
- `backend/users/views.py` - 添加了 SendResetPasswordCodeView 和 ResetPasswordView
- `backend/users/urls.py` - 添加了两个新路由

### 前端
- `frontend/src/views/user/UserProfile.vue` - 在安全设置中添加了重置密码表单

## 部署注意事项

1. **环境变量**
   - 确保 Redis 服务运行正常
   - 确保邮件服务配置正确（EMAIL_HOST_USER, EMAIL_HOST_PASSWORD）

2. **迁移**
   - 无需数据库迁移（使用 Redis 缓存）

3. **测试**
   - 部署前测试邮件发送功能
   - 确认验证码过期时间设置合理

## 更新日志
- **2025-01-26**：实现个人中心邮箱验证重置密码功能
